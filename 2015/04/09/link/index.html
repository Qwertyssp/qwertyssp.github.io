<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="思考并记录"><title>对于链接的一些理解 | Qwerty</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">对于链接的一些理解</h1><a id="logo" href="/.">Qwerty</a><p class="description">不积跬步，无以至千里。不积小流，无以成江海。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">对于链接的一些理解</h1><div class="post-meta">Apr 9, 2015<span> | </span><span class="category"><a href="/categories/C-C/">C/C++</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>最近逛github， 无意间发现一个嵌入式教学者的github，clone了一个他实现的Mini-arm-os（感觉应该是一个教学模型- -），他的开发平台是用的是linux，看了他的代码（感觉自己太水了- -！，似乎废话有点多）。直接谈谈对.ld文件的理解吧。<br><a id="more"></a></p>
<h2 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h2><p>Linux平台不像win下，已经有了简单易用的IDE，编译链接 由IDE全部搞定，链接脚本往往由自己编写，如果对这方面理解不够是很难写出来的。萝卜青菜各有所爱，我认为即使IDE帮我们解决了这些问题，让我们把大部分时间集中在代码的实现上，但是这些基本的东西还是有必要知道的-o-。</p>
<p>对于由OS管理的硬件，程序的运行由加载器帮我们解决了数据以及代码的存储问题，但是对于单片机来讲我们是没有加载器这个东西的，代码以及数据的存放需要我们自己解决。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">ENTRY(main)</div><div class="line"></div><div class="line">MEMORY</div><div class="line">&#123;</div><div class="line">	FLASH (rx) : ORIGIN = <span class="number">0x00000000</span>, LENGTH = <span class="number">128</span>K</div><div class="line">	RAM (rwx) : ORIGIN = <span class="number">0x20000000</span>, LENGTH = <span class="number">40</span>K</div><div class="line">&#125;</div><div class="line"></div><div class="line">SECTIONS</div><div class="line">&#123;</div><div class="line">	.text :</div><div class="line">	&#123;</div><div class="line">		KEEP(*(.isr_vector))</div><div class="line">		*(.text)</div><div class="line">		*(.text.*)</div><div class="line">		*(.rodata)</div><div class="line">		_sromdev = .;</div><div class="line">		_eromdev = .;</div><div class="line">		_sidata = .;</div><div class="line">	&#125; &gt;FLASH</div><div class="line"></div><div class="line">	.data : AT(_sidata)</div><div class="line">	&#123;</div><div class="line">		_sdata = .;</div><div class="line">		*(.data)</div><div class="line">		*(.data*)</div><div class="line">		_edata = .;</div><div class="line">	&#125; &gt;RAM</div><div class="line"></div><div class="line">	.bss :</div><div class="line">	&#123;</div><div class="line">		_sbss = .;</div><div class="line">		*(.bss)</div><div class="line">		_ebss = .;</div><div class="line">	&#125; &gt;RAM</div><div class="line"></div><div class="line">	_estack = ORIGIN(RAM) + LENGTH(RAM);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个编译过的程序一般包括三个段: .text, .data, .bss。简单来讲这三个段的意义如下：</p>
<ul>
<li>.text: 就是代码段，存储可执行的指令</li>
<li>.data: 存储初始化的全局变量以及静态变量</li>
<li>.bss : 存储未初始化的全局变量，赋值为0（应该是个规定吧）</li>
</ul>
<p>RAM中的布局如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">| stack_top |</div><div class="line">| <span class="built_in">stack</span>     |</div><div class="line">| heap      |</div><div class="line">| .bss      |</div><div class="line">| .data     |</div></pre></td></tr></table></figure>
<p>一般情况下，我们在Win下使用MDK编译程序后，会outPut一个信息(这里已我手头的一个程序为例)：</p>
<blockquote>
<p>Program Size: Code=28268 RO-data=3416 ZI-data=5816</p>
</blockquote>
<p>看下MDK的帮助文档，解释如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Code (inc. Data)</div><div class="line">Shows how many bytes are occupied by code. In this image, there are 3712 bytes of code. This includes 1580 bytes of inline data (inc. data), for example, literal pools, and short strings. </div><div class="line"></div><div class="line">RO Data</div><div class="line">Shows how many bytes are occupied by read-only data. This is in addition to the inline data included in the Code (inc. data) column.</div><div class="line"></div><div class="line">RW Data</div><div class="line">Shows how many bytes are occupied by read-write data.</div><div class="line"></div><div class="line">ZI Data</div><div class="line">Shows how many bytes are occupied by zero-initialized data.</div></pre></td></tr></table></figure>
<p>结合MDK编译后生成的.map文件能够看到各数据的存储地址, 仔细观察Memory Map of the image会发现</p>
<p>RO-Data 以及Code 存储的区域起始地址是0x08000000这个正是stm32的FLASH的起始地址，Size的值就是Code + RO-data 的大小， 即.text段</p>
<p>.data .bss 段 的存储区域是0x20000000, 这个地址是STM32的SRAM地址, Size大小也等于RW-data + RI-data.</p>
<p>如果细心还会发现，此段的Size包含了启动文件中我们设置的 head size + stack size，而且这部分数据被初始化为0了。</p>
<p>研究CM3内核发现，复位后的MSP也就是堆栈指针，恰好是0x20000000 + Size 的位置。当然到此所有关于stack heap的理论知识 就很容易验证了。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>这么来讲我们已知的知识，也就是什么全局变量局部变量静态变量乱七八糟的知识基础还是稳固的（ 以前还以为单片机不是这样子的。。。郁闷。。被各种网上的观点误导）。</p>
<p>我们的Heap似乎没有合理利用啊，如果不分配的话（似乎也不算啥结论哈）。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这里只是表达了对程序编译过程的一些理解，整个CM3内核还是挺复杂的。还需继续研究啊。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://nonblock.cn/2015/04/09/link/" data-id="cj7fu5kxe0002hjfulcekbdur" class="article-share-link">分享到</a><div class="tags"><a href="/tags/编程语言/">编程语言</a></div><div class="post-nav"><a href="/2017/03/27/new-start/" class="pre">New Start</a><a href="/2015/03/04/pointers-to-pointers/" class="next">二级指针，以及在链表中的应用</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
  url: document.location.href,
  sourceId: "",
  productKey: "117c068db8134e50b7c156bb0611678c",
  target: "cloud-tie-wrapper"
};</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/编程语言/" style="font-size: 15px;">编程语言</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/11/why-python/">为什么学习python</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/17/symbol-multiple-definition/">符号冲突问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/21/c-array-point/">一个有意思的BUG</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/27/new-start/">New Start</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/09/link/">对于链接的一些理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/04/pointers-to-pointers/">二级指针，以及在链表中的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/01/uip-memory-block-management/">UIP内存管理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.gotocoding.com/" title="重归混沌" target="_blank">重归混沌</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Qwerty |</a><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_size_pv">
本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
<span id="busuanzi_container_size_uv">
本站访客数<span id="busuanzi_value_site_uv"></span>人
</span></div><!--  |  Powered by--><!--  a(rel='nofollow', target='_blank', href='https://hexo.io')  Hexo.--><!--  a(rel='nofollow', target='_blank', href='https://github.com/tufu9441/maupassant-hexo')  Theme--><!--  |  by--><!--  a(rel='nofollow', target='_blank', href='https://github.com/pagecho')  Cho.--></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-97378271-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>